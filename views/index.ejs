<%- include('includes/head.ejs') -%>
    <div class="columns is-multiline is-mobile">
        <div class="column is-full box">
            <h1 class="title">Temperatur Historie</h1>
            <div id="chart"></div>
        </div>

        <div class="column is-full box">
            <h1 class="title">Temperatur Sensoren</h1>
            <table class="table is-fullwidth">
                <tbody>
                    <% state.temperatures.forEach(sensor=> { %>
                        <tr>
                            <td style="width: 50%;">
                                <%= sensor.sensor %>
                            </td>
                            <td>
                                <span class="tag">
                                    <%= sensor.temperature.toFixed(2) %> °C
                                </span>
                            </td>
                        </tr>

                        <%});%>
                </tbody>
            </table>
        </div>

        <div class="column is-full box">
            <h1 class="title">Angeschlossende Geräte</h1>
            <table class="table is-fullwidth">
                <tbody>
                    <tr>
                        <td style="width: 50%;"> Pumpe </td>
                        <td>
                            <div class="content is-flex is-justify-content-space-between" style="width: 100%;">
                                <span class="tag is-<%= state.pump ? 'success' : 'danger' %>" id="pump">
                                    <%= state.pump ? 'An' : 'Aus' %>
                                </span>
                                <button class="button is-small" onclick="toggleState('pump')">Umschalten</button>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 50%;"> Filter </td>
                        <td>
                            <div class="content is-flex is-justify-content-space-between" style="width: 100%;">
                                <span class="tag is-<%= state.filter ? 'success' : 'danger' %>" id="filter">
                                    <%= state.filter ? 'An' : 'Aus' %>
                                </span>
                                <button class="button is-small" onclick="toggleState('filter')">Umschalten</button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="column is-full box">
            <h1 class="title">Trigger <a class="button is-white" href="/trigger"><i class="fa fa-pen"></i></a>   </h1>
            <table class="table is-fullwidth">
                <thead>
                    <tr>
                        <th>Trigger</th>
                        <th>Aktion</th>
                    </tr>
                </thead>
                <tbody>
                    <% trigger.forEach((t, i)=> { %>
                        <tr>
                            <td>
                                <%= t.trigger %>
                            </td>
                            <td>
                                <%= t.action %>
                            </td>
                        </tr>
                        <% }); %>
                </tbody>
            </table>
        </div>
    </div>
    <script src="/static/js/apexcharts.js"></script>
    <link rel="stylesheet" href="/static/css/apexcharts.css">
    <script>
        const options = {};
        options.series = [];
        options.xaxis = {
            type: 'datetime'
        };
        options.chart = {
            height: 350,
            type: "line",
            stacked: false,
            animations: {
                enabled: false,
            }
        };
        options.stroke = {
            curve: 'smooth'
        };

        options.tooltip = {
            x: {
                format: 'dd.MM.yy HH:mm:ss'
            }
        };

        var chart = new ApexCharts(document.querySelector("#chart"), options);

        chart.render();

        const updateSeries = async () => {
            const response = await fetch('/tempLog');
            if (response.ok) {
                const result = await response.json();

                chart.updateSeries(result, false);
            }
        };

        setInterval(updateSeries, 10000)
        updateSeries();

        async function toggleState(which) {
            const response = await fetch(`${location.href}/toggle/${which}`, {
                method: 'POST'
            });

            const result = await response.json();
            $(`#${which}`).text(result.state).removeClass(result.state == 'An' ? 'is-danger' : 'is-success').addClass(result.state == 'An' ? 'is-success' : 'is-danger');
        }
    </script>
    <%- include('includes/foot.ejs') -%>